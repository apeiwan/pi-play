/* eslint-disable */
/*
 * @Author: 伽蓝
 * @Date: 2021-10-20 11:13:50
 * @LastEditTime: 2021-10-20 11:15:49
 * @LastEditors: 伽蓝
 * @FilePath: /pi-play/src/vap/dll/vap.min.js
 * @Description: 
 * 代码不规范,调试泪两行
 */
(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?module.exports=factory():typeof define==="function"&&define.amd?define(factory):(global=typeof globalThis!=="undefined"?globalThis:global||self,global.Vap=factory())})(this,function(){function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}const arrayWithHoles=_arrayWithHoles;function _iterableToArrayLimit(arr,i){if(typeof Symbol==="undefined"||!(Symbol.iterator in Object(arr)))return;const _arr=[];let _n=true;let _d=false;let _e;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i.return!=null)_i.return()}finally{if(_d)throw _e}}return _arr}const iterableToArrayLimit=_iterableToArrayLimit;function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++){arr2[i]=arr[i]}return arr2}const arrayLikeToArray=_arrayLikeToArray;function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return arrayLikeToArray(o,minLen);let n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return arrayLikeToArray(o,minLen)}const unsupportedIterableToArray=_unsupportedIterableToArray;function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}const nonIterableRest=_nonIterableRest;function _slicedToArray(arr,i){return arrayWithHoles(arr)||iterableToArrayLimit(arr,i)||unsupportedIterableToArray(arr,i)||nonIterableRest()}const slicedToArray=_slicedToArray;function createCommonjsModule(fn,module){return module={exports:{}},fn(module,module.exports),module.exports}const runtime_1=createCommonjsModule(function(module){const runtime=function(exports){const Op=Object.prototype;const hasOwn=Op.hasOwnProperty;let undefined$1;const $Symbol=typeof Symbol==="function"?Symbol:{};const iteratorSymbol=$Symbol.iterator||"@@iterator";const asyncIteratorSymbol=$Symbol.asyncIterator||"@@asyncIterator";const toStringTagSymbol=$Symbol.toStringTag||"@@toStringTag";function define(obj,key,value){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});return obj[key]}try{define({},"")}catch(err){define=function(obj,key,value){return obj[key]=value}}function wrap(innerFn,outerFn,self,tryLocsList){const protoGenerator=outerFn&&outerFn.prototype instanceof Generator?outerFn:Generator;const generator=Object.create(protoGenerator.prototype);const context=new Context(tryLocsList||[]);generator._invoke=makeInvokeMethod(innerFn,self,context);return generator}exports.wrap=wrap;function tryCatch(fn,obj,arg){try{return{type:"normal",arg:fn.call(obj,arg)}}catch(err){return{type:"throw",arg:err}}}const GenStateSuspendedStart="suspendedStart";const GenStateSuspendedYield="suspendedYield";const GenStateExecuting="executing";const GenStateCompleted="completed";const ContinueSentinel={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}let IteratorPrototype={};IteratorPrototype[iteratorSymbol]=function(){return this};const getProto=Object.getPrototypeOf;const NativeIteratorPrototype=getProto&&getProto(getProto(values([])));if(NativeIteratorPrototype&&NativeIteratorPrototype!==Op&&hasOwn.call(NativeIteratorPrototype,iteratorSymbol)){IteratorPrototype=NativeIteratorPrototype}const Gp=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(IteratorPrototype);GeneratorFunction.prototype=Gp.constructor=GeneratorFunctionPrototype;GeneratorFunctionPrototype.constructor=GeneratorFunction;GeneratorFunction.displayName=define(GeneratorFunctionPrototype,toStringTagSymbol,"GeneratorFunction");function defineIteratorMethods(prototype){["next","throw","return"].forEach(function(method){define(prototype,method,function(arg){return this._invoke(method,arg)})})}exports.isGeneratorFunction=function(genFun){const ctor=typeof genFun==="function"&&genFun.constructor;return ctor?ctor===GeneratorFunction||(ctor.displayName||ctor.name)==="GeneratorFunction":false};exports.mark=function(genFun){if(Object.setPrototypeOf){Object.setPrototypeOf(genFun,GeneratorFunctionPrototype)}else{genFun.__proto__=GeneratorFunctionPrototype;define(genFun,toStringTagSymbol,"GeneratorFunction")}genFun.prototype=Object.create(Gp);return genFun};exports.awrap=function(arg){return{__await:arg}};function AsyncIterator(generator,PromiseImpl){function invoke(method,arg,resolve,reject){const record=tryCatch(generator[method],generator,arg);if(record.type==="throw"){reject(record.arg)}else{const result=record.arg;const{value}=result;if(value&&typeof value==="object"&&hasOwn.call(value,"__await")){return PromiseImpl.resolve(value.__await).then(function(value){invoke("next",value,resolve,reject)},function(err){invoke("throw",err,resolve,reject)})}return PromiseImpl.resolve(value).then(function(unwrapped){result.value=unwrapped;resolve(result)},function(error){return invoke("throw",error,resolve,reject)})}}let previousPromise;function enqueue(method,arg){function callInvokeWithMethodAndArg(){return new PromiseImpl(function(resolve,reject){invoke(method,arg,resolve,reject)})}return previousPromise=previousPromise?previousPromise.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}this._invoke=enqueue}defineIteratorMethods(AsyncIterator.prototype);AsyncIterator.prototype[asyncIteratorSymbol]=function(){return this};exports.AsyncIterator=AsyncIterator;exports.async=function(innerFn,outerFn,self,tryLocsList,PromiseImpl){if(PromiseImpl===void 0)PromiseImpl=Promise;const iter=new AsyncIterator(wrap(innerFn,outerFn,self,tryLocsList),PromiseImpl);return exports.isGeneratorFunction(outerFn)?iter:iter.next().then(function(result){return result.done?result.value:iter.next()})};function makeInvokeMethod(innerFn,self,context){let state=GenStateSuspendedStart;return function invoke(method,arg){if(state===GenStateExecuting){throw new Error("Generator is already running")}if(state===GenStateCompleted){if(method==="throw"){throw arg}return doneResult()}context.method=method;context.arg=arg;while(true){const{delegate}=context;if(delegate){const delegateResult=maybeInvokeDelegate(delegate,context);if(delegateResult){if(delegateResult===ContinueSentinel)continue;return delegateResult}}if(context.method==="next"){context.sent=context._sent=context.arg}else if(context.method==="throw"){if(state===GenStateSuspendedStart){state=GenStateCompleted;throw context.arg}context.dispatchException(context.arg)}else if(context.method==="return"){context.abrupt("return",context.arg)}state=GenStateExecuting;const record=tryCatch(innerFn,self,context);if(record.type==="normal"){state=context.done?GenStateCompleted:GenStateSuspendedYield;if(record.arg===ContinueSentinel){continue}return{value:record.arg,done:context.done}}if(record.type==="throw"){state=GenStateCompleted;context.method="throw";context.arg=record.arg}}}}function maybeInvokeDelegate(delegate,context){const method=delegate.iterator[context.method];if(method===undefined$1){context.delegate=null;if(context.method==="throw"){if(delegate.iterator.return){context.method="return";context.arg=undefined$1;maybeInvokeDelegate(delegate,context);if(context.method==="throw"){return ContinueSentinel}}context.method="throw";context.arg=new TypeError("The iterator does not provide a 'throw' method")}return ContinueSentinel}const record=tryCatch(method,delegate.iterator,context.arg);if(record.type==="throw"){context.method="throw";context.arg=record.arg;context.delegate=null;return ContinueSentinel}const info=record.arg;if(!info){context.method="throw";context.arg=new TypeError("iterator result is not an object");context.delegate=null;return ContinueSentinel}if(info.done){context[delegate.resultName]=info.value;context.next=delegate.nextLoc;if(context.method!=="return"){context.method="next";context.arg=undefined$1}}else{return info}context.delegate=null;return ContinueSentinel}defineIteratorMethods(Gp);define(Gp,toStringTagSymbol,"Generator");Gp[iteratorSymbol]=function(){return this};Gp.toString=function(){return"[object Generator]"};function pushTryEntry(locs){const entry={tryLoc:locs[0]};if(1 in locs){entry.catchLoc=locs[1]}if(2 in locs){entry.finallyLoc=locs[2];entry.afterLoc=locs[3]}this.tryEntries.push(entry)}function resetTryEntry(entry){const record=entry.completion||{};record.type="normal";delete record.arg;entry.completion=record}function Context(tryLocsList){this.tryEntries=[{tryLoc:"root"}];tryLocsList.forEach(pushTryEntry,this);this.reset(true)}exports.keys=function(object){const keys=[];for(const key in object){keys.push(key)}keys.reverse();return function next(){while(keys.length){const key=keys.pop();if(key in object){next.value=key;next.done=false;return next}}next.done=true;return next}};function values(iterable){if(iterable){const iteratorMethod=iterable[iteratorSymbol];if(iteratorMethod){return iteratorMethod.call(iterable)}if(typeof iterable.next==="function"){return iterable}if(!isNaN(iterable.length)){let i=-1;const next=function next(){while(++i<iterable.length){if(hasOwn.call(iterable,i)){next.value=iterable[i];next.done=false;return next}}next.value=undefined$1;next.done=true;return next};return next.next=next}}return{next:doneResult}}exports.values=values;function doneResult(){return{value:undefined$1,done:true}}Context.prototype={constructor:Context,reset(skipTempReset){this.prev=0;this.next=0;this.sent=this._sent=undefined$1;this.done=false;this.delegate=null;this.method="next";this.arg=undefined$1;this.tryEntries.forEach(resetTryEntry);if(!skipTempReset){for(const name in this){if(name.charAt(0)==="t"&&hasOwn.call(this,name)&&!isNaN(+name.slice(1))){this[name]=undefined$1}}}},stop(){this.done=true;const rootEntry=this.tryEntries[0];const rootRecord=rootEntry.completion;if(rootRecord.type==="throw"){throw rootRecord.arg}return this.rval},dispatchException(exception){if(this.done){throw exception}const context=this;function handle(loc,caught){record.type="throw";record.arg=exception;context.next=loc;if(caught){context.method="next";context.arg=undefined$1}return!!caught}for(let i=this.tryEntries.length-1;i>=0;--i){const entry=this.tryEntries[i];var record=entry.completion;if(entry.tryLoc==="root"){return handle("end")}if(entry.tryLoc<=this.prev){const hasCatch=hasOwn.call(entry,"catchLoc");const hasFinally=hasOwn.call(entry,"finallyLoc");if(hasCatch&&hasFinally){if(this.prev<entry.catchLoc){return handle(entry.catchLoc,true)}if(this.prev<entry.finallyLoc){return handle(entry.finallyLoc)}}else if(hasCatch){if(this.prev<entry.catchLoc){return handle(entry.catchLoc,true)}}else if(hasFinally){if(this.prev<entry.finallyLoc){return handle(entry.finallyLoc)}}else{throw new Error("try statement without catch or finally")}}}},abrupt(type,arg){for(let i=this.tryEntries.length-1;i>=0;--i){const entry=this.tryEntries[i];if(entry.tryLoc<=this.prev&&hasOwn.call(entry,"finallyLoc")&&this.prev<entry.finallyLoc){var finallyEntry=entry;break}}if(finallyEntry&&(type==="break"||type==="continue")&&finallyEntry.tryLoc<=arg&&arg<=finallyEntry.finallyLoc){finallyEntry=null}const record=finallyEntry?finallyEntry.completion:{};record.type=type;record.arg=arg;if(finallyEntry){this.method="next";this.next=finallyEntry.finallyLoc;return ContinueSentinel}return this.complete(record)},complete(record,afterLoc){if(record.type==="throw"){throw record.arg}if(record.type==="break"||record.type==="continue"){this.next=record.arg}else if(record.type==="return"){this.rval=this.arg=record.arg;this.method="return";this.next="end"}else if(record.type==="normal"&&afterLoc){this.next=afterLoc}return ContinueSentinel},finish(finallyLoc){for(let i=this.tryEntries.length-1;i>=0;--i){const entry=this.tryEntries[i];if(entry.finallyLoc===finallyLoc){this.complete(entry.completion,entry.afterLoc);resetTryEntry(entry);return ContinueSentinel}}},catch(tryLoc){for(let i=this.tryEntries.length-1;i>=0;--i){const entry=this.tryEntries[i];if(entry.tryLoc===tryLoc){const record=entry.completion;if(record.type==="throw"){var thrown=record.arg;resetTryEntry(entry)}return thrown}}throw new Error("illegal catch attempt")},delegateYield(iterable,resultName,nextLoc){this.delegate={iterator:values(iterable),resultName:resultName,nextLoc:nextLoc};if(this.method==="next"){this.arg=undefined$1}return ContinueSentinel}};return exports}(module.exports);try{regeneratorRuntime=runtime}catch(accidentalStrictMode){Function("r","regeneratorRuntime = r")(runtime)}});const D__project_vapSource_web_node_modules__babel_runtime_regenerator=runtime_1;function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}const classCallCheck=_classCallCheck;function _defineProperties(target,props){for(let i=0;i<props.length;i++){const descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor}const createClass=_createClass;const getPrototypeOf=createCommonjsModule(function(module){function _getPrototypeOf(o){module.exports=_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)};return _getPrototypeOf(o)}module.exports=_getPrototypeOf});function _superPropBase(object,property){while(!Object.prototype.hasOwnProperty.call(object,property)){object=getPrototypeOf(object);if(object===null)break}return object}const superPropBase=_superPropBase;const get=createCommonjsModule(function(module){function _get(target,property,receiver){if(typeof Reflect!=="undefined"&&Reflect.get){module.exports=_get=Reflect.get}else{module.exports=_get=function _get(target,property,receiver){const base=superPropBase(target,property);if(!base)return;const desc=Object.getOwnPropertyDescriptor(base,property);if(desc.get){return desc.get.call(receiver)}return desc.value}}return _get(target,property,receiver||target)}module.exports=_get});const setPrototypeOf=createCommonjsModule(function(module){function _setPrototypeOf(o,p){module.exports=_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(o,p){o.__proto__=p;return o};return _setPrototypeOf(o,p)}module.exports=_setPrototypeOf});function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function")}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:true,configurable:true}});if(superClass)setPrototypeOf(subClass,superClass)}const inherits=_inherits;const _typeof_1=createCommonjsModule(function(module){function _typeof(obj){"@babel/helpers - typeof";if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){module.exports=_typeof=function _typeof(obj){return typeof obj}}else{module.exports=_typeof=function _typeof(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj}}return _typeof(obj)}module.exports=_typeof});function _assertThisInitialized(self){if(self===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return self}const assertThisInitialized=_assertThisInitialized;function _possibleConstructorReturn(self,call){if(call&&(_typeof_1(call)==="object"||typeof call==="function")){return call}return assertThisInitialized(self)}const possibleConstructorReturn=_possibleConstructorReturn;const getPrototypeOf$1=createCommonjsModule(function(module){function _getPrototypeOf(o){module.exports=_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)};return _getPrototypeOf(o)}module.exports=_getPrototypeOf});function __awaiter(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P(function(resolve){resolve(value)})}return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})}const FrameParser=function(){function FrameParser(source,headData){classCallCheck(this,FrameParser);this.config=source||{};this.headData=headData;this.frame=[];this.textureMap={}}createClass(FrameParser,[{key:"init",value:function init(){return __awaiter(this,void 0,void 0,D__project_vapSource_web_node_modules__babel_runtime_regenerator.mark(function _callee(){return D__project_vapSource_web_node_modules__babel_runtime_regenerator.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:this.initCanvas();if(!/\/\/[-A-Za-z0-9+&@#/%?=~_|!:,.;]+[-A-Za-z0-9+&@#/%=~_|]\.json$/.test(this.config)){_context.next=5;break}_context.next=4;return this.getConfigBySrc(this.config);case 4:this.config=_context.sent;case 5:_context.next=7;return this.parseSrc(this.config);case 7:this.canvas.parentNode.removeChild(this.canvas);this.frame=this.config.frame||[];return _context.abrupt("return",this);case 10:case"end":return _context.stop()}}},_callee,this)}))}},{key:"initCanvas",value:function initCanvas(){const canvas=document.createElement("canvas");const ctx=canvas.getContext("2d");canvas.style.display="none";document.body.appendChild(canvas);this.ctx=ctx;this.canvas=canvas}},{key:"loadImg",value:function loadImg(url){return new Promise(function(resolve,reject){const img=new Image;img.crossOrigin="anonymous";img.onload=function(){resolve(this)};img.onerror=function(e){console.error("frame 资源加载失败:"+url);reject(new Error("frame 资源加载失败:"+url))};img.src=url})}},{key:"parseSrc",value:function parseSrc(dataJson){const _this=this;const src=this.srcData={};return Promise.all((dataJson.src||[]).map(function(item){return __awaiter(_this,void 0,void 0,D__project_vapSource_web_node_modules__babel_runtime_regenerator.mark(function _callee2(){const _this2=this;return D__project_vapSource_web_node_modules__babel_runtime_regenerator.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:item.img=null;if(this.headData[item.srcTag.slice(1,item.srcTag.length-1)]){_context2.next=5;break}console.warn("vap: 融合信息没有传入：".concat(item.srcTag));_context2.next=21;break;case 5:if(!(item.srcType==="txt")){_context2.next=10;break}item.textStr=item.srcTag.replace(/\[(.*)\]/,function($0,$1){return _this2.headData[$1]});item.img=this.makeTextImg(item);_context2.next=20;break;case 10:if(!(item.srcType==="img")){_context2.next=20;break}item.imgUrl=item.srcTag.replace(/\[(.*)\]/,function($0,$1){return _this2.headData[$1]});_context2.prev=12;_context2.next=15;return this.loadImg(item.imgUrl+"?t="+Date.now());case 15:item.img=_context2.sent;_context2.next=20;break;case 18:_context2.prev=18;_context2.t0=_context2.catch(12);case 20:if(item.img){src[item.srcId]=item}case 21:case"end":return _context2.stop()}}},_callee2,this,[[12,18]])}))}))}},{key:"getConfigBySrc",value:function getConfigBySrc(jsonUrl){return new Promise(function(resolve,reject){const xhr=new XMLHttpRequest;xhr.open("GET",jsonUrl,true);xhr.responseType="json";xhr.onload=function(){if(xhr.status===200||xhr.status===304&&xhr.response){const res=xhr.response;resolve(res)}else{reject(new Error("http response invalid"+xhr.status))}};xhr.send()})}},{key:"makeTextImg",value:function makeTextImg(_ref){const{textStr}=_ref;const{w}=_ref;const{h}=_ref;const{color}=_ref;const{style}=_ref;const{ctx}=this;ctx.canvas.width=w;ctx.canvas.height=h;const fontSize=Math.min(w/textStr.length,h-8);const font=["".concat(fontSize,"px"),"Arial"];if(style==="b"){font.unshift("bold")}ctx.font=font.join(" ");ctx.textBaseline="middle";ctx.textAlign="center";ctx.fillStyle=color;ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);ctx.fillText(textStr,w/2,h/2);return ctx.getImageData(0,0,w,h)}},{key:"getFrame",value:function getFrame(frame){return this.frame.find(function(item){return item.i===frame})}}]);return FrameParser}();function createShader(gl,type,source){const shader=gl.createShader(type);gl.shaderSource(shader,source);gl.compileShader(shader);return shader}function createProgram(gl,vertexShader,fragmentShader){const program=gl.createProgram();gl.attachShader(program,vertexShader);gl.attachShader(program,fragmentShader);gl.linkProgram(program);gl.useProgram(program);return program}function createTexture(gl,index,imgData){const texture=gl.createTexture();const textrueIndex=gl.TEXTURE0+index;gl.activeTexture(textrueIndex);gl.bindTexture(gl.TEXTURE_2D,texture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);if(imgData){gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,imgData)}return texture}const VapVideo=function(){function VapVideo(options){classCallCheck(this,VapVideo);if(!options.container||!options.src){console.warn("[Alpha video]: options container and src cannot be empty!")}this.options={src:"",loop:false,fps:20,width:375,height:375,container:null,precache:false,mute:false,config:"",accurate:false,...options};this.fps=20;this.setBegin=true;this.useFrameCallback=false;this.requestAnim=this.requestAnimFunc();this.container=this.options.container;if(!this.options.src||!this.options.config||!this.options.container){console.error("参数出错：src(视频地址)、config(配置文件地址)、container(dom容器)")}else{this.initVideo()}}createClass(VapVideo,[{key:"precacheSource",value:function precacheSource(source){const URL=window.webkitURL||window.URL;return new Promise(function(resolve,reject){const xhr=new XMLHttpRequest;xhr.open("GET",source,true);xhr.responseType="blob";xhr.onload=function(){if(xhr.status===200||xhr.status===304){const res=xhr.response;if(/iphone|ipad|ipod/i.test(navigator.userAgent)){const fileReader=new FileReader;fileReader.onloadend=function(){const resultStr=fileReader.result;const raw=atob(resultStr.slice(resultStr.indexOf(",")+1));const buf=Array(raw.length);for(let d=0;d<raw.length;d++){buf[d]=raw.charCodeAt(d)}const arr=new Uint8Array(buf);const blob=new Blob([arr],{type:"video/mp4"});resolve(URL.createObjectURL(blob))};fileReader.readAsDataURL(xhr.response)}else{resolve(URL.createObjectURL(res))}}else{reject(new Error("http response invalid"+xhr.status))}};xhr.send()})}},{key:"initVideo",value:function initVideo(){const _this=this;const{options}=this;const video=this.video=document.createElement("video");video.crossOrigin="anonymous";video.autoplay=false;video.preload="auto";video.setAttribute("playsinline","");video.setAttribute("webkit-playsinline","");if(options.mute){video.muted=true;video.volume=0}video.style.display="none";video.loop=!!options.loop;window.enableInlineVideo&&window.enableInlineVideo(video);if(options.precache){this.precacheSource(options.src).then(function(blob){console.log("sample precached.");video.src=blob;document.body.appendChild(video)}).catch(function(e){console.error(e)})}else{video.src=options.src;document.body.appendChild(this.video);video.load()}if("requestVideoFrameCallback"in this.video){this.useFrameCallback=!!this.options.accurate}this.events={};["playing","pause","ended","error","canplay"].forEach(function(item){_this.on(item,_this["on"+item].bind(_this))})}},{key:"drawFrame",value:function drawFrame(_,info){this._drawFrame=this._drawFrame||this.drawFrame.bind(this,_,info);if(this.useFrameCallback){this.animId=this.video.requestVideoFrameCallback(this.drawFrame.bind(this))}else{this.animId=this.requestAnim(this._drawFrame)}}},{key:"play",value:function play(){const _this2=this;const prom=this.video&&this.video.play();if(prom&&prom.then){prom.catch(function(e){if(!_this2.video){return}_this2.video.muted=true;_this2.video.volume=0;_this2.video.play().catch(function(e){(_this2.events.error||[]).forEach(function(item){item(e)})})})}}},{key:"pause",value:function pause(){this.video&&this.video.pause()}},{key:"setTime",value:function setTime(t){if(this.video){this.video.currentTime=t}}},{key:"requestAnimFunc",value:function requestAnimFunc(){const me=this;if(window.requestAnimationFrame){let index=-1;return function(cb){index++;return requestAnimationFrame(function(){if(!(index%(60/me.fps))){return cb()}me.animId=me.requestAnim(cb)})}}return function(cb){return setTimeout(cb,1e3/me.fps)}}},{key:"cancelRequestAnimation",value:function cancelRequestAnimation(){if(this.useFrameCallback){try{this.video.cancelVideoFrameCallback(this.animId)}catch(e){}}else if(window.cancelAnimationFrame){cancelAnimationFrame(this.animId)}else{clearTimeout(this.animId)}}},{key:"destroy",value:function destroy(){this.cancelRequestAnimation();if(this.video){this.video.parentNode&&this.video.parentNode.removeChild(this.video);this.video=null}this.options.onDestory&&this.options.onDestory()}},{key:"clear",value:function clear(){this.destroy()}},{key:"on",value:function on(event,callback){const cbs=this.events[event]||[];cbs.push(callback);this.events[event]=cbs;this.video.addEventListener(event,callback);return this}},{key:"onplaying",value:function onplaying(){if(!this.firstPlaying){this.firstPlaying=true;if(this.useFrameCallback){this.animId=this.video.requestVideoFrameCallback(this.drawFrame.bind(this))}else{this.drawFrame(null,null)}}}},{key:"onpause",value:function onpause(){}},{key:"onended",value:function onended(){this.destroy()}},{key:"oncanplay",value:function oncanplay(){const begin=this.options.beginPoint;if(begin&&this.setBegin){this.setBegin=false;this.video.currentTime=begin}}},{key:"onerror",value:function onerror(err){console.error("[Alpha video]: play error: ",err);this.destroy();this.options.onLoadError&&this.options.onLoadError(err)}}]);return VapVideo}();function _createSuper(Derived){const hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){const Super=getPrototypeOf$1(Derived);let result;if(hasNativeReflectConstruct){const NewTarget=getPrototypeOf$1(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else{result=Super.apply(this,arguments)}return possibleConstructorReturn(this,result)}}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],function(){}));return true}catch(e){return false}}let clearTimer=null;let instances={};const PER_SIZE=9;function computeCoord(x,y,w,h,vw,vh){return[x/vw,(x+w)/vw,(vh-y-h)/vh,(vh-y)/vh]}const WebglRenderVap=function(_VapVideo){inherits(WebglRenderVap,_VapVideo);const _super=_createSuper(WebglRenderVap);function WebglRenderVap(options){let _this;classCallCheck(this,WebglRenderVap);_this=_super.call(this,options);_this.insType=_this.options.type;if(instances[_this.insType]){_this.instance=instances[_this.insType]}else{_this.instance=instances[_this.insType]={}}_this.textures=[];_this.buffers=[];_this.shaders=[];_this.init();return _this}createClass(WebglRenderVap,[{key:"init",value:function init(){return __awaiter(this,void 0,void 0,D__project_vapSource_web_node_modules__babel_runtime_regenerator.mark(function _callee(){return D__project_vapSource_web_node_modules__babel_runtime_regenerator.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:this.setCanvas();if(!this.options.config){_context.next=12;break}_context.prev=2;_context.next=5;return new FrameParser(this.options.config,this.options).init();case 5:this.vapFrameParser=_context.sent;this.resources=this.vapFrameParser.srcData;_context.next=12;break;case 9:_context.prev=9;_context.t0=_context.catch(2);console.error("[Alpha video] parse vap frame error.",_context.t0);case 12:this.resources=this.resources||{};this.initWebGL();this.play();case 15:case"end":return _context.stop()}}},_callee,this,[[2,9]])}))}},{key:"setCanvas",value:function setCanvas(){let{canvas}=this.instance;const _this$options=this.options;const{width}=_this$options;const{height}=_this$options;if(!canvas){canvas=this.instance.canvas=document.createElement("canvas")}canvas.width=width;canvas.height=height;this.container.appendChild(canvas)}},{key:"initWebGL",value:function initWebGL(){const{canvas}=this.instance;const _this$instance=this.instance;let{gl}=_this$instance;let{vertexShader}=_this$instance;let{fragmentShader}=_this$instance;let{program}=_this$instance;if(!canvas){return}if(!gl){this.instance.gl=gl=canvas.getContext("webgl")||canvas.getContext("experimental-webgl");gl.disable(gl.BLEND);gl.blendFuncSeparate(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA,gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,true)}gl.clear(gl.COLOR_BUFFER_BIT);if(gl){gl.viewport(0,0,canvas.width,canvas.height);if(!vertexShader){vertexShader=this.instance.vertexShader=this.initVertexShader()}if(!fragmentShader){fragmentShader=this.instance.fragmentShader=this.initFragmentShader()}if(!program){program=this.instance.program=createProgram(gl,vertexShader,fragmentShader)}this.program=program;this.initTexture();this.initVideoTexture();return gl}}},{key:"initVertexShader",value:function initVertexShader(){const{gl}=this.instance;return createShader(gl,gl.VERTEX_SHADER,"attribute vec2 a_position; // 接受顶点坐标\n             attribute vec2 a_texCoord; // 接受纹理坐标\n             attribute vec2 a_alpha_texCoord; // 接受纹理坐标\n             varying vec2 v_alpha_texCoord; // 接受纹理坐标\n             varying   vec2 v_texcoord; // 传递纹理坐标给片元着色器\n             void main(void){\n                gl_Position = vec4(a_position, 0.0, 1.0); // 设置坐标\n                v_texcoord = a_texCoord; // 设置纹理坐标\n                v_alpha_texCoord = a_alpha_texCoord; // 设置纹理坐标\n             }")}},{key:"initFragmentShader",value:function initFragmentShader(){const{gl}=this.instance;const bgColor="vec4(texture2D(u_image_video, v_texcoord).rgb, texture2D(u_image_video,v_alpha_texCoord).r);";const textureSize=gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS)-1;let sourceTexure="";let sourceUniform="";if(textureSize>0){const imgColor=[];const samplers=[];for(let i=0;i<textureSize;i++){imgColor.push("if(ndx == ".concat(i+1,"){\n                        color = texture2D(u_image").concat(i+1,",uv);\n                    }"));samplers.push("uniform sampler2D u_image".concat(i+1,";"))}sourceUniform="\n            ".concat(samplers.join("\n"),"\n            uniform float image_pos[").concat(textureSize*PER_SIZE,"];\n            vec4 getSampleFromArray(int ndx, vec2 uv) {\n                vec4 color;\n                ").concat(imgColor.join(" else "),"\n                return color;\n            }\n            ");sourceTexure="\n            vec4 srcColor,maskColor;\n            vec2 srcTexcoord,maskTexcoord;\n            int srcIndex;\n            float x1,x2,y1,y2,mx1,mx2,my1,my2; //显示的区域\n\n            for(int i=0;i<".concat(textureSize*PER_SIZE,";i+= ").concat(PER_SIZE,"){\n                if ((int(image_pos[i]) > 0)) {\n                  srcIndex = int(image_pos[i]);\n    \n                    x1 = image_pos[i+1];\n                    x2 = image_pos[i+2];\n                    y1 = image_pos[i+3];\n                    y2 = image_pos[i+4];\n                    \n                    mx1 = image_pos[i+5];\n                    mx2 = image_pos[i+6];\n                    my1 = image_pos[i+7];\n                    my2 = image_pos[i+8];\n    \n    \n                    if (v_texcoord.s>x1 && v_texcoord.s<x2 && v_texcoord.t>y1 && v_texcoord.t<y2) {\n                        srcTexcoord = vec2((v_texcoord.s-x1)/(x2-x1),(v_texcoord.t-y1)/(y2-y1));\n                         maskTexcoord = vec2(mx1+srcTexcoord.s*(mx2-mx1),my1+srcTexcoord.t*(my2-my1));\n                         srcColor = getSampleFromArray(srcIndex,srcTexcoord);\n                         maskColor = texture2D(u_image_video, maskTexcoord);\n                         srcColor.a = srcColor.a*(maskColor.r);\n                      \n                         bgColor = vec4(srcColor.rgb*srcColor.a,srcColor.a) + (1.0-srcColor.a)*bgColor;\n                      \n                    }   \n                }\n            }\n            ")}const fragmentSharder="\n        precision lowp float;\n        varying vec2 v_texcoord;\n        varying vec2 v_alpha_texCoord;\n        uniform sampler2D u_image_video;\n        ".concat(sourceUniform,"\n        \n        void main(void) {\n            vec4 bgColor = ").concat(bgColor,"\n            ").concat(sourceTexure,"\n            // bgColor = texture2D(u_image[0], v_texcoord);\n            gl_FragColor = bgColor;\n        }\n        ");return createShader(gl,gl.FRAGMENT_SHADER,fragmentSharder)}},{key:"initTexture",value:function initTexture(){const{gl}=this.instance;let i=1;if(!this.vapFrameParser||!this.vapFrameParser.srcData){return}const resources=this.vapFrameParser.srcData;for(const key in resources){const resource=resources[key];this.textures.push(createTexture(gl,i,resource.img));const _sampler=gl.getUniformLocation(this.program,"u_image".concat(i));gl.uniform1i(_sampler,i);this.vapFrameParser.textureMap[resource.srcId]=i++}const dumpTexture=gl.createTexture();gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,dumpTexture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,1,1,0,gl.RGBA,gl.UNSIGNED_BYTE,null);this.videoTexture=createTexture(gl,i);const sampler=gl.getUniformLocation(this.program,"u_image_video");gl.uniform1i(sampler,i)}},{key:"initVideoTexture",value:function initVideoTexture(){const{gl}=this.instance;const vertexBuffer=gl.createBuffer();this.buffers.push(vertexBuffer);if(!this.vapFrameParser||!this.vapFrameParser.config||!this.vapFrameParser.config.info){return}const{info}=this.vapFrameParser.config;const ver=[];const vW=info.videoW;const vH=info.videoH;const _info$rgbFrame=slicedToArray(info.rgbFrame,4);const rgbX=_info$rgbFrame[0];const rgbY=_info$rgbFrame[1];const rgbW=_info$rgbFrame[2];const rgbH=_info$rgbFrame[3];const _info$aFrame=slicedToArray(info.aFrame,4);const aX=_info$aFrame[0];const aY=_info$aFrame[1];const aW=_info$aFrame[2];const aH=_info$aFrame[3];const rgbCoord=computeCoord(rgbX,rgbY,rgbW,rgbH,vW,vH);const aCoord=computeCoord(aX,aY,aW,aH,vW,vH);ver.push.apply(ver,[-1,1,rgbCoord[0],rgbCoord[3],aCoord[0],aCoord[3]]);ver.push.apply(ver,[1,1,rgbCoord[1],rgbCoord[3],aCoord[1],aCoord[3]]);ver.push.apply(ver,[-1,-1,rgbCoord[0],rgbCoord[2],aCoord[0],aCoord[2]]);ver.push.apply(ver,[1,-1,rgbCoord[1],rgbCoord[2],aCoord[1],aCoord[2]]);const view=new Float32Array(ver);gl.bindBuffer(gl.ARRAY_BUFFER,vertexBuffer);gl.bufferData(gl.ARRAY_BUFFER,view,gl.STATIC_DRAW);this.aPosition=gl.getAttribLocation(this.program,"a_position");gl.enableVertexAttribArray(this.aPosition);this.aTexCoord=gl.getAttribLocation(this.program,"a_texCoord");gl.enableVertexAttribArray(this.aTexCoord);this.aAlphaTexCoord=gl.getAttribLocation(this.program,"a_alpha_texCoord");gl.enableVertexAttribArray(this.aAlphaTexCoord);const size=view.BYTES_PER_ELEMENT;gl.vertexAttribPointer(this.aPosition,2,gl.FLOAT,false,size*6,0);gl.vertexAttribPointer(this.aTexCoord,2,gl.FLOAT,false,size*6,size*2);gl.vertexAttribPointer(this.aAlphaTexCoord,2,gl.FLOAT,false,size*6,size*4)}},{key:"drawFrame",value:function drawFrame(_,info){const _this2=this;const{gl}=this.instance;if(!gl){get(getPrototypeOf$1(WebglRenderVap.prototype),"drawFrame",this).call(this,_,info);return}gl.clear(gl.COLOR_BUFFER_BIT);if(this.vapFrameParser){const timePoint=info&&info.mediaTime>=0?info.mediaTime:this.video.currentTime;const frame=Math.floor(timePoint*this.options.fps);const frameData=this.vapFrameParser.getFrame(frame);let posArr=[];if(frameData&&frameData.obj){frameData.obj.forEach(function(frame,index){posArr[posArr.length]=+_this2.vapFrameParser.textureMap[frame.srcId];const{info}=_this2.vapFrameParser.config;const vW=info.videoW;const vH=info.videoH;const _info$rgbFrame2=slicedToArray(info.rgbFrame,2);const rgbX=_info$rgbFrame2[0];const rgbY=_info$rgbFrame2[1];const _frame$frame=slicedToArray(frame.frame,4);const x=_frame$frame[0];const y=_frame$frame[1];const w=_frame$frame[2];const h=_frame$frame[3];const _frame$mFrame=slicedToArray(frame.mFrame,4);const mX=_frame$mFrame[0];const mY=_frame$mFrame[1];const mW=_frame$mFrame[2];const mH=_frame$mFrame[3];const coord=computeCoord(x+rgbX,y+rgbY,w,h,vW,vH);const mCoord=computeCoord(mX,mY,mW,mH,vW,vH);posArr=posArr.concat(coord).concat(mCoord)})}const size=(gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS)-1)*PER_SIZE;posArr=posArr.concat(new Array(size-posArr.length).fill(0));this._imagePos=this._imagePos||gl.getUniformLocation(this.program,"image_pos");gl.uniform1fv(this._imagePos,new Float32Array(posArr))}gl.texImage2D(gl.TEXTURE_2D,0,gl.RGB,gl.RGB,gl.UNSIGNED_BYTE,this.video);gl.drawArrays(gl.TRIANGLE_STRIP,0,4);get(getPrototypeOf$1(WebglRenderVap.prototype),"drawFrame",this).call(this,_,info)}},{key:"destroy",value:function destroy(){const _this$instance2=this.instance;const{canvas}=_this$instance2;const{gl}=_this$instance2;if(this.textures&&this.textures.length){for(let i=0;i<this.textures.length;i++){gl.deleteTexture(this.textures[i])}}if(canvas){canvas.parentNode&&canvas.parentNode.removeChild(canvas)}get(getPrototypeOf$1(WebglRenderVap.prototype),"destroy",this).call(this);this.clearMemoryCache()}},{key:"clearMemoryCache",value:function clearMemoryCache(){if(clearTimer){clearTimeout(clearTimer)}clearTimer=setTimeout(function(){instances={}},30*60*1e3)}}]);return WebglRenderVap}(VapVideo);let isCanWebGL;function index(options){if(canWebGL()){return new WebglRenderVap({...options})}throw new Error("your browser not support webgl")}function canWebGL(){if(typeof isCanWebGL!=="undefined"){return isCanWebGL}try{if(!window.WebGLRenderingContext){return false}const canvas=document.createElement("canvas");let context=canvas.getContext("webgl")||canvas.getContext("experimental-webgl");isCanWebGL=!!context;context=null}catch(err){isCanWebGL=false}return isCanWebGL}return index});